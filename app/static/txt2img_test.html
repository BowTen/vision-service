<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>文生图测试 (txt2img)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
        }

        body {
            margin: 0;
            padding: 1.25rem;
            max-width: 820px;
            line-height: 1.5;
        }

        h1 {
            font-size: 1.4rem;
            margin-top: 0;
        }

        section {
            margin-bottom: 1.2rem;
        }

        label {
            display: block;
            margin: .4rem 0 .2rem;
            font-weight: 600;
        }

        input[type=text],
        textarea,
        select {
            width: 100%;
            padding: .55rem .7rem;
            border: 1px solid #888;
            border-radius: 6px;
            font: inherit;
            background: transparent;
        }

        textarea {
            min-height: 90px;
            resize: vertical;
        }

        button {
            cursor: pointer;
            padding: .6rem 1.1rem;
            border: 1px solid #555;
            border-radius: 6px;
            background: #222;
            color: #fff;
            font: inherit;
        }

        button:disabled {
            opacity: .55;
            cursor: not-allowed;
        }

        .radio-row {
            display: flex;
            gap: 1.2rem;
            margin-top: .3rem;
        }

        .progress-box {
            margin-top: .6rem;
            padding: .5rem .7rem;
            border: 1px solid #aaa;
            border-radius: 6px;
            font-size: .9rem;
            background: rgba(0, 0, 0, .04);
            min-height: 2.2rem;
        }

        #imagePreview {
            margin-top: .8rem;
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        footer {
            margin-top: 2rem;
            font-size: .75rem;
            opacity: .7;
        }

        .inline {
            display: inline-block;
        }

        .flex-row {
            display: flex;
            gap: .6rem;
            align-items: center;
            flex-wrap: wrap;
        }

        small {
            font-size: .7rem;
            opacity: .7;
            display: block;
            margin-top: .15rem;
        }

        hr {
            border: none;
            border-top: 1px solid #ccc;
            margin: 1.6rem 0;
        }
    </style>
</head>

<body>
    <h1>文生图测试 (txt2img)</h1>

    <section>
        <label>后端 IP:Port（可含协议）</label>
        <input id="backend" type="text" placeholder="例如：127.0.0.1:8000 或 http://127.0.0.1:8000" />
        <label>协议</label>
        <div class="radio-row">
            <label><input type="radio" name="proto" value="http" checked /> HTTP</label>
            <label><input type="radio" name="proto" value="websocket" /> WebSocket</label>
        </div>
    </section>

    <section>
        <label>提示词 Prompt</label>
        <textarea id="prompt" placeholder="描述要生成的图像..."></textarea>
    </section>

    <section class="flex-row">
        <button id="generateBtn">生成图片</button>
        <button id="clearBtn" type="button">清空</button>
    </section>

    <section>
        <div class="progress-box" id="progressBox">进度：--</div>
        <img id="imagePreview" alt="生成结果图片将在此显示" />
    </section>

    <footer>© 简洁测试页面，仅用于开发调试。</footer>

    <script>
        const backendInput = document.getElementById('backend');
        const promptInput = document.getElementById('prompt');
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const progressBox = document.getElementById('progressBox');
        const imagePreview = document.getElementById('imagePreview');

        clearBtn.addEventListener('click', () => {
            promptInput.value = '';
            progressBox.textContent = '进度：--';
            imagePreview.src = '';
        });

        function normalizeBase(url) {
            url = url.trim();
            if (!url) return '';
            if (!/^https?:\/\//i.test(url)) {
                url = 'http://' + url;
            }
            return url.replace(/\/+$/, ''); // remove trailing slash
        }
        function toWsURL(httpUrl) {
            return httpUrl.replace(/^http/i, 'ws');
        }

        generateBtn.addEventListener('click', async () => {
            const base = normalizeBase(backendInput.value);
            const prompt = promptInput.value.trim();
            if (!base) { alert('请输入后端地址'); return; }
            if (!prompt) { alert('Prompt 不能为空'); return; }
            const proto = document.querySelector('input[name="proto"]:checked').value;

            generateBtn.disabled = true;
            progressBox.textContent = '进度：开始请求...';
            imagePreview.src = '';

            if (proto === 'http') {
                try {
                    const resp = await fetch(base + '/txt2img/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    if (!resp.ok) throw new Error('HTTP错误 ' + resp.status);
                    const blob = await resp.blob();
                    progressBox.textContent = '进度：完成 100%';
                    imagePreview.src = URL.createObjectURL(blob);
                } catch (e) {
                    progressBox.textContent = '错误：' + e.message;
                } finally {
                    generateBtn.disabled = false;
                }
                return;
            }

            // WebSocket
            try {
                const wsUrl = toWsURL(base) + '/txt2img/ws/generate';
                const ws = new WebSocket(wsUrl);
                let got100 = false;

                ws.binaryType = 'blob';

                ws.onopen = () => {
                    progressBox.textContent = '进度：连接成功，发送 Prompt';
                    ws.send(prompt);
                };
                ws.onmessage = ev => {
                    if (typeof ev.data === 'string') {
                        if (ev.data === '100') {
                            got100 = true;
                            progressBox.textContent = '进度：生成完成，等待图片数据...';
                        } else if (/^\d+$/.test(ev.data)) {
                            progressBox.textContent = '进度：' + ev.data + '%';
                        } else {
                            // 非预期文本消息
                            progressBox.textContent = '收到文本消息：' + ev.data;
                        }
                    } else {
                        // Blob (图片)
                        if (!got100) {
                            progressBox.textContent = '收到二进制但未收到100标记（可能服务实现变化）';
                        } else {
                            progressBox.textContent = '进度：完成 100%';
                        }
                        imagePreview.src = URL.createObjectURL(ev.data);
                    }
                };
                ws.onerror = () => {
                    progressBox.textContent = 'WebSocket 错误';
                    generateBtn.disabled = false;
                };
                ws.onclose = () => {
                    generateBtn.disabled = false;
                };
            } catch (e) {
                progressBox.textContent = '连接失败：' + e.message;
                generateBtn.disabled = false;
            }
        });
    </script>
</body>

</html>